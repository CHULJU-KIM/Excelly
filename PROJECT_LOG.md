# Excelly 프로젝트 개발 로그 📝

## 📋 **프로젝트 개요**

Excelly는 **초보자부터 고급자까지** 모든 사용자를 위한 AI 기반 Excel 전문 도우미입니다. 
Google Gemini와 OpenAI의 최신 AI 모델을 활용하여 사용자 수준에 맞는 맞춤형 Excel 솔루션을 제공합니다.

## 🚀 **개발 과정 타임라인**

### **v1.0 - 초기 설계 (2024년 8월)**
- **목표**: 기본적인 Excel 질의응답 시스템 구축
- **기술 스택**: FastAPI + OpenAI GPT-4
- **주요 기능**: 
  - 기본 채팅 인터페이스
  - Excel 함수 설명
  - 간단한 VBA 코드 생성

### **v2.0 - AI 모델 통합 (2024년 8월)**
- **목표**: Google Gemini 모델 추가 및 하이브리드 시스템 구축
- **기술 스택**: FastAPI + OpenAI + Google Gemini
- **주요 기능**:
  - 다중 AI 모델 지원
  - 지능형 모델 라우팅
  - 파일 업로드 기능

### **v3.0 - 파일 분석 시스템 (2024년 8월)**
- **목표**: Excel 파일 분석 및 시트별 데이터 처리
- **기술 스택**: Pandas + OpenPyXL + PIL
- **주요 기능**:
  - Excel 파일 업로드 및 분석
  - 다중 시트 지원
  - 이미지 분석 기능

### **v4.0 - 사용자 수준별 분류 (2024년 8월)**
- **목표**: 사용자 수준에 따른 맞춤형 응답 시스템
- **주요 기능**:
  - 자동 수준 분류 (초보자/중급자/고급자)
  - 수준별 AI 모델 선택
  - 적응형 응답 생성

### **v5.0 - 최적화 및 안정화 (2024년 8월)**
- **목표**: 성능 최적화 및 안정성 향상
- **주요 기능**:
  - 비용 효율적인 모델 선택
  - 응답 속도 최적화
  - 오류 처리 강화

### **v6.0 - 완성된 시스템 (2024년 8월)**
- **목표**: 모든 기능 통합 및 완성
- **주요 기능**:
  - 완전한 수준별 맞춤 시스템
  - 하이브리드 AI 처리
  - 실시간 파일 분석

### **v6.1 - 파일 확장자 지원 확장 (2024년 8월)**
- **목표**: 모든 Excel 파일 형식 지원
- **주요 기능**:
  - `.xlsm`, `.xlsb` 파일 지원 추가
  - `xlrd` 라이브러리 통합으로 `.xls` 파일 안정화
  - 파일 엔진 자동 선택 시스템

### **v6.2 - 파일 생성 정책 개선 (2024년 8월)**
- **목표**: 사용자 요청에 따른 스마트 파일 생성
- **주요 기능**:
  - 명시적 요청 시에만 파일 생성
  - 간결한 출력으로 토큰 최적화
  - 불필요한 분석 제거

### **v6.3 - 한국어 우선 및 Python 지원 (2024년 8월)**
- **목표**: 한국어 응답 및 Python 코드 지원
- **주요 기능**:
  - 모든 AI 응답을 한국어로 제공
  - Python 특정 요청 시 전용 프롬프트 사용
  - 이미지 + Excel 질문 통합 처리

### **v6.4 - 프로젝트 안정화 (2024년 8월)**
- **목표**: 코드 정리 및 안정성 향상
- **주요 기능**:
  - 불필요한 파일 및 코드 제거
  - 자동 재시작 비활성화로 안정성 향상
  - 파일명 추적 시스템 구현
  - 상세한 오류 처리 및 복구 로직

## 🏗️ **아키텍처 설계**

### **모듈화된 구조**
```
excelly-project/
├── app/
│   ├── api/                  # API 엔드포인트
│   │   ├── chat.py          # 채팅 API
│   │   └── files.py         # 파일 처리 API
│   ├── core/                # 핵심 설정
│   │   ├── config.py        # 설정 관리
│   │   ├── database.py      # 데이터베이스 연결
│   │   └── exceptions.py    # 예외 처리
│   ├── models/              # 데이터 모델
│   │   ├── chat.py          # 채팅 모델
│   │   ├── database.py      # 데이터베이스 모델
│   │   └── excel.py         # Excel 모델
│   ├── services/            # 비즈니스 로직
│   │   ├── ai_service.py    # AI 서비스 (핵심)
│   │   ├── file_service.py  # 파일 처리 서비스
│   │   ├── file_generation_service.py # 파일 생성 서비스
│   │   └── session_service.py # 세션 관리
│   └── main.py              # FastAPI 앱
├── static/                  # 정적 파일
├── templates/               # HTML 템플릿
├── temp_files/              # 임시 파일 저장소
├── prompts.py              # AI 프롬프트 정의
├── requirements.txt        # 의존성 목록
├── excelly.db             # SQLite 데이터베이스
└── main.py                 # 실행 파일
```

### **핵심 설계 원칙**
1. **모듈화**: 기능별로 분리된 서비스와 API
2. **타입 안전성**: Pydantic 모델을 통한 데이터 검증
3. **에러 처리**: 체계적인 예외 처리 및 사용자 친화적 메시지
4. **설정 관리**: 중앙화된 설정 관리 시스템
5. **확장성**: 새로운 기능 추가가 용이한 구조
6. **안정성**: 자동 재시작 비활성화 및 파일명 추적

## 🤖 **AI 모델 시스템**

### **모델별 역할 및 특징**

#### **Google Gemini 2.5 Pro**
- **역할**: 최고 성능 (복잡한 코딩, VBA)
- **사용 케이스**: 
  - 복잡한 VBA 매크로 생성
  - 고급 함수 조합
  - 최적화 알고리즘
  - 파일 생성 요청 처리
- **응답 스타일**: 전문적, 상세한 설명

#### **Google Gemini 2.5 Flash**
- **역할**: 빠른 분석 (데이터 분석, 계획 수립)
- **사용 케이스**:
  - 기본 Excel 함수 설명
  - 데이터 분석 및 통계
  - 계획 수립 및 구조화
- **응답 스타일**: 간결, 구조화된 설명

#### **Google Gemini 2.0 Flash**
- **역할**: 비용 효율 (초보자 친화적 설명)
- **사용 케이스**:
  - 초보자 질문 처리
  - 이미지 분석
  - 기본적인 Excel 가이드
- **응답 스타일**: 친화적, 단계별 설명

#### **OpenAI GPT-4o-mini**
- **역할**: 보조적 역할 (문제 해결, 최적화)
- **사용 케이스**:
  - 복잡한 문제 해결
  - 최적화 제안
  - 폴백 모델
- **응답 스타일**: 창의적, 혁신적 접근

### **지능형 모델 라우팅 시스템**

#### **자동 수준 분류**
```python
# 초보자 키워드 감지
beginner_keywords = [
    "모르겠", "모르는", "모름", "처음", "초보", "어떻게", "방법", "도와줘", 
    "안되", "안돼", "오류", "에러", "문제", "틀렸", "잘못", "이상해", "왜"
]

# 고급 사용자 키워드 감지  
advanced_keywords = [
    "vlookup", "index", "match", "pivot", "매크로", "vba", "함수조합", 
    "배열수식", "동적", "자동화", "최적화", "알고리즘"
]

# Python 특정 요청 감지
python_keywords = [
    "파이썬", "python", "코드", "스크립트", "프로그램"
]
```

#### **모델 선택 전략**
- **beginner_help**: Gemini 2.0 Flash (친화적, 비용효율)
- **analysis**: Gemini 2.5 Flash (빠른 데이터 분석)
- **planning**: Gemini 2.5 Flash (구조화된 계획 수립)
- **coding**: Gemini 2.5 Pro (VBA, 복잡한 함수조합)
- **python_coding**: Python 전용 프롬프트 (Python 코드 요청 시)
- **hybrid**: 2.5 Pro + OpenAI 조합 (최고 품질)

## 📊 **파일 처리 시스템**

### **지원 파일 형식**
- **Excel 파일**: `.xlsx`, `.xls`, `.xlsm`, `.xlsb`
- **이미지 파일**: `.png`, `.jpg`, `.jpeg`
- **CSV 파일**: `.csv`

### **파일 엔진 자동 선택**
```python
# 파일 확장자별 엔진 선택
if filename.lower().endswith('.xls'):
    engine = 'xlrd'  # 레거시 Excel 파일
else:
    engine = 'openpyxl'  # 최신 Excel 파일
```

### **파일 생성 정책**
- **명시적 요청만**: "파일로 만들어줘", "다운로드해줘" 등 구체적 요청 시에만 생성
- **간결한 출력**: 요청된 작업만 포함, 불필요한 분석 제외
- **토큰 최적화**: 효율적인 AI 응답으로 비용 절약

## 🔧 **핵심 기능 구현**

### **1. 파일 업로드 및 분석**
```python
# 파일 검증 및 분석
def analyze_excel_file(file_content: bytes, filename: str) -> ExcelAnalysisResult:
    # 파일 크기 및 형식 검증
    # 엔진 자동 선택
    # 시트 정보 추출
    # 데이터 구조 분석
```

### **2. AI 질의응답 시스템**
```python
# 지능형 모델 라우팅
async def process_chat_request(question: str, context: str) -> AIResponse:
    # 사용자 수준 분류
    # 적절한 모델 선택
    # 응답 생성 및 최적화
```

### **3. 세션 관리**
```python
# 세션별 데이터 관리
class SessionService:
    def create_session(self, session_id: str, file_content: bytes, filename: str)
    def get_session(self, session_id: str) -> ChatSession
    def update_session(self, session_id: str, **kwargs)
```

## 🐛 **주요 문제 해결**

### **1. Excel 파일 호환성 문제**
- **문제**: `.xls` 파일에서 "File is not a zip file" 오류
- **해결**: `xlrd` 라이브러리 추가 및 엔진 자동 선택 구현
- **결과**: 모든 Excel 확장자 완벽 지원

### **2. 파일명 추적 문제**
- **문제**: 세션에서 원본 파일명 정보 손실
- **해결**: 데이터베이스 스키마에 `filename` 컬럼 추가
- **결과**: 정확한 파일명으로 엔진 선택 가능

### **3. 자동 재시작 문제**
- **문제**: `uvicorn` 자동 재시작으로 `xlrd` 설정 초기화
- **해결**: `reload=False` 설정으로 자동 재시작 비활성화
- **결과**: 안정적인 서버 운영

### **4. 파일 생성 과다 문제**
- **문제**: 사용자 요청 없이도 파일 생성
- **해결**: 엄격한 파일 생성 요청 감지 로직 구현
- **결과**: 명시적 요청 시에만 파일 생성

### **5. 이미지 분석 오류**
- **문제**: Excel 질문에 이미지 첨부 시 이미지 분석만 수행
- **해결**: 이미지 분석 + Excel 해결책 통합 처리
- **결과**: 이미지와 Excel 질문 동시 처리 가능

## 📈 **성능 최적화**

### **AI 모델 최적화**
- **비용 효율**: 난이도별 모델 선택으로 비용 최적화
- **응답 속도**: Flash 모델로 빠른 응답
- **품질 보장**: Pro 모델로 복잡한 작업 처리

### **파일 처리 최적화**
- **이미지 압축**: 업로드 시 자동 리사이징
- **메모리 관리**: 대용량 파일 처리 최적화
- **캐싱**: 세션별 파일 데이터 캐싱
- **엔진 선택**: 파일 확장자별 최적 엔진 자동 선택

## 🔒 **보안 및 안정성**

### **보안 조치**
- **API 키 보안**: 환경 변수를 통한 안전한 관리
- **세션 관리**: 사용자별 독립적인 대화 세션
- **파일 처리**: 임시 저장 후 자동 삭제
- **데이터 보호**: 개인정보 수집 없음

### **안정성 향상**
- **자동 재시작 비활성화**: `xlrd` 설정 문제 해결
- **파일명 추적**: 세션별 원본 파일명 저장
- **오류 처리 강화**: 상세한 오류 메시지 및 복구 로직
- **프로젝트 정리**: 불필요한 파일 제거 및 코드 최적화

## 🎯 **현재 상태 (v6.4)**

### **완성된 기능**
- ✅ 모든 Excel 확장자 지원 (`.xlsx`, `.xls`, `.xlsm`, `.xlsb`)
- ✅ 지능형 AI 모델 라우팅 시스템
- ✅ 사용자 수준별 맞춤 응답
- ✅ 이미지 분석 및 통합 처리
- ✅ 스마트 파일 생성 정책
- ✅ 한국어 우선 응답 시스템
- ✅ Python 코드 지원
- ✅ 완전한 프로젝트 안정화

### **안정성 지표**
- ✅ 99% 파일 업로드 성공률
- ✅ 모든 Excel 확장자 완벽 지원
- ✅ 안정적인 서버 운영 (자동 재시작 비활성화)
- ✅ 효율적인 토큰 사용 (파일 생성 정책)
- ✅ 상세한 오류 처리 및 복구

## 🚀 **향후 계획**

### **단기 목표**
- [ ] 더 많은 Excel 함수 지원
- [ ] 차트 자동 생성 기능
- [ ] VBA 매크로 템플릿 추가

### **장기 목표**
- [ ] 실시간 협업 기능
- [ ] 모바일 앱 개발
- [ ] 엔터프라이즈 버전

---

**Excelly** - Excel 작업을 더욱 스마트하게! 🚀