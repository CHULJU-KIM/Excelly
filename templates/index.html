<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI ì—‘ì…€ í•´ê²°ì‚¬ 'ì—‘ì…€ë¦¬' ğŸ¤–</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤–</text></svg>">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
:root { --primary-color: #1a73e8; --bg-light: #f0f2f5; --bg-panel: #e9eef6; --border-color: #dcdcdc; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-light); color: #333; margin: 0; font-size: 15px; overflow: hidden; }
.main-layout { display: flex; width: 100vw; height: 100vh; }

/* âœ¨ [ì—…ê·¸ë ˆì´ë“œ] History Panel CSS */
.history-panel {
    width: 280px;
    background-color: var(--bg-panel);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    transition: margin-left 0.3s ease;
    flex-shrink: 0;
}
.history-header { padding: 15px; text-align: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
.history-header h2 { margin: 0; font-size: 18px; }
.history-list { list-style: none; padding: 10px; margin: 0; overflow-y: auto; flex-grow: 1; }
.history-item { padding: 12px 15px; margin-bottom: 8px; background-color: white; border-radius: 8px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; border: 1px solid transparent; transition: all 0.2s; }
.history-item:hover { border-color: var(--primary-color); }
.history-item.active { border-color: var(--primary-color); background-color: #dbeaff; font-weight: bold; }
.new-chat-btn { margin: 10px; padding: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; text-align: center; flex-shrink: 0; }
.new-chat-btn:hover { background-color: #1558b8; }
.close-history-btn, .open-history-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 0 5px; color: #555; }

/* âœ¨ [ì‹ ê·œ] Panel ìˆ¨ê¹€/ë³´ì„ ì²˜ë¦¬ */
.open-history-btn { position: fixed; top: 10px; left: 10px; z-index: 1001; background-color: rgba(255,255,255,0.8); border-radius: 50%; width: 40px; height: 40px; display: none; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
@media (max-width: 768px) {
    .history-panel { position: fixed; height: 100%; z-index: 1000; margin-left: -281px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
    .history-panel.visible { margin-left: 0; }
    .open-history-btn { display: flex; }
}

.container { flex-grow: 1; height: 100vh; background-color: white; display: flex; flex-direction: column; }
header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); text-align: center; flex-shrink: 0; }
h1 { margin: 0; font-size: 24px; color: var(--primary-color); }
.chatbox { flex-grow: 1; padding: 20px; overflow-y: auto; }
.message-wrapper { margin-bottom: 20px; display: flex; flex-direction: column; }
.message { max-width: 90%; padding: 10px 16px; border-radius: 18px; line-height: 1.6; word-wrap: break-word; }
.user-wrapper { align-items: flex-end; }
.ai-wrapper { align-items: flex-start; }
.user { background-color: var(--primary-color); color: white; }
.user img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
.ai { background-color: var(--bg-panel); color: #333; }
.ai pre { position: relative; background-color: #282c34; color: #abb2bf; padding: 1.2em 1em 1em; border-radius: 8px; overflow-x: auto; margin: 1em 0; }
.copy-button { position: absolute; top: 5px; right: 5px; background-color: #4f5666; color: white; border: none; padding: 4px 8px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7; }
/* âœ¨ [ì‹ ê·œ] ì‹œíŠ¸ ì„ íƒ UI */
.sheet-selection { margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; }
.sheet-btn { background-color: #fff; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 8px 15px; margin: 5px; border-radius: 20px; cursor: pointer; transition: all 0.2s; }
.sheet-btn:hover { background-color: var(--primary-color); color: #fff; }

.feedback-section { padding: 10px 0 0; text-align: right; }
.feedback-button { background: none; border: 1px solid #ccc; padding: 5px 12px; border-radius: 15px; cursor: pointer; margin-left: 8px; font-size: 13px; }
.feedback-button:hover { background-color: var(--bg-light); }
.input-area { padding: 15px 20px; border-top: 1px solid var(--border-color); background-color: #fff; flex-shrink: 0; }
.input-form { display: flex; gap: 10px; align-items: center; }
#userInput { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 18px; font-size: 15px; }
.file-button, .submit-button { background-color: var(--primary-color); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 20px; flex-shrink: 0; display: flex; justify-content: center; align-items: center; }
.file-button:hover, .submit-button:hover { background-color: #1558b8; }
#pasted-image-preview { max-width: 100px; max-height: 40px; margin-right: 10px; border-radius: 5px; object-fit: cover; }
.file-name-display { font-size: 12px; color: #666; margin-right: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
</style>
</head>
<body>

<div class="main-layout">
    <button class="open-history-btn" onclick="toggleHistoryPanel()">â˜°</button>
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h2>ëŒ€í™” ê¸°ë¡ ğŸ“–</h2>
            <button class="close-history-btn" onclick="toggleHistoryPanel()">Ã—</button>
        </div>
        <button class="new-chat-btn" onclick="startNewChat()">+ ìƒˆ ëŒ€í™” ì‹œì‘í•˜ê¸°</button>
        <button class="clear-history-btn" onclick="clearCurrentSession()" style="margin: 0 10px 10px; padding: 8px; background-color: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">ğŸ—‘ï¸ í˜„ì¬ ëŒ€í™” ì§€ìš°ê¸°</button>
        <button class="clear-all-history-btn" onclick="clearAllSessions()" style="margin: 0 10px 10px; padding: 8px; background-color: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">ğŸ—‘ï¸ ëª¨ë“  ëŒ€í™” ì§€ìš°ê¸°</button>
        <ul class="history-list" id="historyList"></ul>
    </div>

    <div class="container">
        <header>
            <h1>AI ì—‘ì…€ í•´ê²°ì‚¬ 'ì—‘ì…€ë¦¬' ğŸ¤–âœ¨</h1>
            <div id="ai-status" style="font-size: 12px; color: #666; margin-top: 5px;">
                <span id="status-text">AI ìƒíƒœ í™•ì¸ ì¤‘...</span>
                <span id="model-info" style="margin-left: 10px;"></span>
            </div>
        </header>
        <div class="chatbox" id="chatbox"></div>
        <div class="input-area" id="main-input-area">
            <form class="input-form" id="chatForm" onsubmit="handleFormSubmit(event)">
                <div id="file-name-display" class="file-name-display"></div>
                <img id="pasted-image-preview" style="display:none;">
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileChange(event)" accept=".xlsx, .xls, .csv">
                <button type="button" class="file-button" onclick="document.getElementById('fileInput').click()" title="íŒŒì¼ ì²¨ë¶€">ğŸ“</button>
                <input type="text" id="userInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜, ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”">
                <button type="submit" class="submit-button" title="ì „ì†¡">ğŸš€</button>
            </form>
        </div>
    </div>
</div>

<script>
    const chatForm = document.getElementById('chatForm');
    const userInput = document.getElementById('userInput');
    const fileInput = document.getElementById('fileInput');
    const chatbox = document.getElementById('chatbox');
    const historyPanel = document.getElementById('historyPanel');
    const historyList = document.getElementById('historyList');
    const imagePreview = document.getElementById('pasted-image-preview');
    const fileNameDisplay = document.getElementById('file-name-display');

    let currentSessionId = sessionStorage.getItem('excellySessionId');
    let isWaitingForResponse = false;
    let pastedImageFile = null;
    
    // AI ìƒíƒœ í™•ì¸
    async function checkAIStatus() {
        try {
            const response = await fetch('/api/chat/status');
            const status = await response.json();
            
            const statusText = document.getElementById('status-text');
            const modelInfo = document.getElementById('model-info');
            
            if (status.status === 'healthy') {
                const aiService = status.ai_service;
                statusText.textContent = 'âœ… AI ì„œë¹„ìŠ¤ ì •ìƒ';
                statusText.style.color = '#28a745';
                
                // ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ì •ë³´ í‘œì‹œ
                const availableModels = [];
                if (aiService.openai_available) availableModels.push('OpenAI');
                if (aiService.gemini_available) availableModels.push('Gemini Pro');
                if (aiService.gemini_flash_available) availableModels.push('Gemini Flash');
                
                modelInfo.textContent = `ì‚¬ìš© ê°€ëŠ¥: ${availableModels.join(', ')}`;
                modelInfo.style.color = '#666';
            } else {
                statusText.textContent = 'âŒ AI ì„œë¹„ìŠ¤ ì˜¤ë¥˜';
                statusText.style.color = '#dc3545';
                modelInfo.textContent = '';
            }
        } catch (error) {
            const statusText = document.getElementById('status-text');
            statusText.textContent = 'âš ï¸ AI ì„œë¹„ìŠ¤ ì—°ê²° ì‹¤íŒ¨';
            statusText.style.color = '#ffc107';
        }
    }

    function toggleHistoryPanel() {
        historyPanel.classList.toggle('visible');
    }

    document.addEventListener('DOMContentLoaded', async () => {
        if (!currentSessionId) {
            currentSessionId = 'session_' + Date.now() + Math.random();
            sessionStorage.setItem('excellySessionId', currentSessionId);
        }
        await checkAIStatus();
        await loadSessions();
        await loadCurrentChat();
    });

    async function loadSessions() {
        try {
            const response = await fetch('/api/chat/sessions');
            if (!response.ok) return;
            const sessions = await response.json();
            historyList.innerHTML = '';
            
            // ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ë¹ˆ ìƒíƒœë¡œ ìœ ì§€
            if (!sessions || sessions.length === 0) {
                return;
            }
            
            sessions.forEach(session => {
                const li = document.createElement('li');
                li.className = 'history-item';
                let firstMessage = (session.first_message || 'ìƒˆë¡œìš´ ëŒ€í™”').replace(/^ì§ˆë¬¸: /, '');
                li.textContent = firstMessage;
                li.title = firstMessage;
                li.dataset.sessionId = session.session_id;
                if (session.session_id === currentSessionId) {
                    li.classList.add('active');
                }
                li.onclick = () => selectSession(session.session_id);
                historyList.appendChild(li);
            });
        } catch (error) {
            console.error("ì„¸ì…˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", error);
        }
    }

    async function selectSession(sessionId) {
        currentSessionId = sessionId;
        sessionStorage.setItem('excellySessionId', sessionId);
        sessionStorage.removeItem('excellyConversationContext'); // Clear local context
        
        // Update active state in history list
        document.querySelectorAll('.history-item').forEach(item => {
            item.classList.remove('active');
        });
        const activeItem = document.querySelector(`[data-session-id="${sessionId}"]`);
        if (activeItem) {
            activeItem.classList.add('active');
        }
        
        // Load the selected session's chat history
        await loadCurrentChat();
    }
    
    function startNewChat() {
        // Generate new session ID
        currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('excellySessionId', currentSessionId);
        sessionStorage.removeItem('excellyConversationContext');
        
        // Clear chat display and add welcome message
        chatbox.innerHTML = '';
        addWelcomeMessage();
        
        // Update active state in history list
        document.querySelectorAll('.history-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Refresh session list to include new session
        loadSessions();
    }

    async function clearCurrentSession() {
        if (!currentSessionId) {
            alert('ì§€ìš¸ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (!confirm('í˜„ì¬ ëŒ€í™” ê¸°ë¡ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/chat/sessions/${currentSessionId}/messages`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Clear chat display
                chatbox.innerHTML = '';
                sessionStorage.removeItem('excellyConversationContext');
                
                // Add welcome message
                addWelcomeMessage();
                
                // Refresh session list
                await loadSessions();
                
                alert('ëŒ€í™” ê¸°ë¡ì´ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.');
            } else {
                const errorData = await response.json();
                alert(`ëŒ€í™” ê¸°ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorData.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }
        } catch (error) {
            console.error('ëŒ€í™” ê¸°ë¡ ì‚­ì œ ì˜¤ë¥˜:', error);
            alert('ëŒ€í™” ê¸°ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function clearAllSessions() {
        if (!confirm('ëª¨ë“  ëŒ€í™” ê¸°ë¡ì„ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/chat/sessions/all', {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Clear chat display
                chatbox.innerHTML = '';
                sessionStorage.removeItem('excellySessionId');
                sessionStorage.removeItem('excellyConversationContext');
                currentSessionId = null;
                
                // Clear session list completely
                historyList.innerHTML = '';
                
                // Add welcome message
                addWelcomeMessage();
                
                alert('ëª¨ë“  ëŒ€í™” ê¸°ë¡ì´ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.');
            } else {
                const errorData = await response.json();
                alert(`ëŒ€í™” ê¸°ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorData.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }
        } catch (error) {
            console.error('ëŒ€í™” ê¸°ë¡ ì‚­ì œ ì˜¤ë¥˜:', error);
            alert('ëŒ€í™” ê¸°ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function loadCurrentChat() {
        chatbox.innerHTML = '';
        if (currentSessionId) {
            const loadingMessage = addMessage('ai', 'ì´ì „ ëŒ€í™” ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... ğŸ§');
            try {
                const response = await fetch(`/api/chat/history/${currentSessionId}`);
                if(loadingMessage) loadingMessage.remove();
                if (response.ok) {
                    const data = await response.json();
                    const history = data.messages || data; // Backward compatibility
                    const conversationContext = data.conversation_context;
                    
                    let lastMessageWrapper = null;
                    history.forEach(msg => {
                        let content = msg.content;
                        if (msg.role === 'user' && content.startsWith('ì§ˆë¬¸: ')) {
                            content = content.substring(4).trim();
                        }
                        lastMessageWrapper = addMessage(msg.role, content, msg.role === 'ai');
                    });
                    if(lastMessageWrapper && history.length > 0 && history[history.length-1].role === 'ai'){
                         addFeedbackUI(lastMessageWrapper);
                    }
                    
                    // Store conversation context for continuity
                    if (conversationContext) {
                        sessionStorage.setItem('excellyConversationContext', JSON.stringify(conversationContext));
                    }
                    
                    if (history.length > 0) {
                        addMessage('ai', 'ì•ˆë…•í•˜ì„¸ìš”! ì´ì „ ëŒ€í™”ì— ì´ì–´ì„œ ê³„ì†í• ê¹Œìš”? ğŸ˜‰');
                    } else {
                        addWelcomeMessage();
                    }
                } else {
                    addWelcomeMessage();
                }
            } catch (error) {
                if(loadingMessage) loadingMessage.remove();
                addWelcomeMessage();
            }
        } else {
            addWelcomeMessage();
        }
    }
    
    function addWelcomeMessage() {
        addMessage('ai', 'ì•ˆë…•í•˜ì„¸ìš”! ì—‘ì…€ì— ê´€í•œ ê²ƒì´ë¼ë©´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”. í•¨ìˆ˜, VBA, í”¼ë²— í…Œì´ë¸”... ì „ë¶€ í™˜ì˜ì…ë‹ˆë‹¤! ğŸ˜‰ íŒŒì¼ì„ ì²¨ë¶€í•˜ê±°ë‚˜, ì˜¤ë¥˜ í™”ë©´ì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ì–´ ë³´ì„¸ìš”!');
    }

    function addMessage(sender, content, isHtml = false, imageUrl = null) {
        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${sender}-wrapper`;
        const message = document.createElement('div');
        message.className = `message ${sender}`;
        if (isHtml) {
            message.innerHTML = marked.parse(content || '');
        } else {
            message.textContent = content;
        }
        if (imageUrl) {
            const imgElement = document.createElement('img');
            imgElement.src = imageUrl;
            message.appendChild(imgElement);
        }
        wrapper.appendChild(message);
        chatbox.appendChild(wrapper);
        chatbox.scrollTop = chatbox.scrollHeight;
        if (isHtml && sender === 'ai') {
            message.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
                const pre = block.parentElement;
                if (pre.querySelector('.copy-button')) return;
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = 'Copy';
                copyButton.onclick = () => {
                    navigator.clipboard.writeText(block.textContent).then(() => {
                        copyButton.textContent = 'Copied!';
                        setTimeout(() => { copyButton.textContent = 'Copy'; }, 2000);
                    });
                };
                pre.appendChild(copyButton);
            });
        }
        return wrapper;
    }

    async function handleFileChange(event) {
        const file = event.target.files[0];
        if (!file) return;

        addMessage('user', `(íŒŒì¼ ì²¨ë¶€: ${file.name})`);
        const loadingWrapper = addMessage('ai', 'íŒŒì¼ì„ ë¶„ì„í•˜ì—¬ ì‹œíŠ¸ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘... ğŸ§');

        const formData = new FormData();
        formData.append('file', file);
        formData.append('session_id', currentSessionId);

        try {
            const response = await fetch('/api/chat/analyze-sheets', { method: 'POST', body: formData });
            const data = await response.json();
            if (response.ok) {
                loadingWrapper.remove();
                displaySheetSelection(data.sheets);
            } else {
                throw new Error(data.detail || 'ì‹œíŠ¸ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            if(loadingWrapper) loadingWrapper.remove();
            addMessage('ai', `ì˜¤ë¥˜: ${error.message}`);
        }
    }

    function displaySheetSelection(sheets) {
        const wrapper = addMessage('ai', 'ì–´ë–¤ ì‹œíŠ¸ë¥¼ ë¶„ì„í•´ë“œë¦´ê¹Œìš”?');
        const selectionDiv = document.createElement('div');
        selectionDiv.className = 'sheet-selection';

        sheets.forEach(sheet => {
            const btn = document.createElement('button');
            btn.className = 'sheet-btn';
            btn.textContent = sheet;
            btn.onclick = () => sendQuestionWithSheet(sheet);
            selectionDiv.appendChild(btn);
        });
        
        if (sheets.length > 1) {
            const allBtn = document.createElement('button');
            allBtn.className = 'sheet-btn';
            allBtn.textContent = 'ëª¨ë“  ì‹œíŠ¸';
            allBtn.onclick = () => sendQuestionWithSheet('all_sheets');
            selectionDiv.appendChild(allBtn);
        }
        wrapper.querySelector('.message').appendChild(selectionDiv);
    }
    
    async function handleFormSubmit(event) {
        event.preventDefault();
        if (fileInput.files.length > 0) {
             addMessage('ai', 'â˜ï¸ ë¨¼ì € ìœ„ì—ì„œ ë¶„ì„í•  ì‹œíŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
             return;
        }
        await sendQuestionWithSheet(null);
    }

    async function sendQuestionWithSheet(selectedSheet) {
        if (isWaitingForResponse) return;
        const question = userInput.value.trim();
        if (question === '' && !pastedImageFile && !selectedSheet) return;

        const sheetSelectionUI = document.querySelector('.sheet-selection');
        if (sheetSelectionUI) sheetSelectionUI.parentElement.remove();
        
        if (!selectedSheet) addMessage('user', question);

        const formData = new FormData();
        formData.append('question', question);
        formData.append('session_id', currentSessionId);
        if (selectedSheet) formData.append('selected_sheet', selectedSheet);
        if (pastedImageFile) formData.append('image', pastedImageFile, 'pasted_image.png');
        
        await sendFormData(formData);
    }

    async function sendFormData(formData) {
        isWaitingForResponse = true;
        const loadingWrapper = addMessage('ai', 'ğŸ¤– ìƒê° ì¤‘...');
        try {
            const response = await fetch('/api/chat/ask', { method: 'POST', body: formData });
            if(loadingWrapper) loadingWrapper.remove();
            const data = await response.json();
            if (response.ok) {
                const aiWrapper = addMessage('ai', data.answer, true);
                
                // Handle different response types
                if (data.response_type === 'clarification') {
                    // Add clarification-specific UI
                    addClarificationUI(aiWrapper, data.conversation_state);
                } else if (data.response_type === 'solution') {
                    // Add feedback UI for solutions
                    addFeedbackUI(aiWrapper);
                } else {
                    // Normal response
                    addFeedbackUI(aiWrapper);
                }
                
                // Update input placeholder based on conversation state
                updateInputPlaceholder(data.conversation_state);
                
            } else {
                throw new Error(data.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            if(loadingWrapper) loadingWrapper.remove();
            addMessage('ai', `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        } finally {
            isWaitingForResponse = false;
            resetInput();
        }
    }
    
    function addClarificationUI(parentWrapper, conversationState) {
        if (parentWrapper.querySelector('.clarification-section')) return;
        
        const clarificationSection = document.createElement('div');
        clarificationSection.className = 'clarification-section';
        clarificationSection.style.padding = '10px 0';
        clarificationSection.style.borderTop = '1px solid #eee';
        clarificationSection.style.marginTop = '10px';
        
        const statusText = document.createElement('div');
        statusText.style.fontSize = '12px';
        statusText.style.color = '#666';
        statusText.style.marginBottom = '5px';
        statusText.textContent = 'ğŸ’¡ ëª…í™•í™” ì§„í–‰ ì¤‘... ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”!';
        
        clarificationSection.appendChild(statusText);
        parentWrapper.appendChild(clarificationSection);
    }
    
    function updateInputPlaceholder(conversationState) {
        const userInput = document.getElementById('userInput');
        if (conversationState === 'clarifying') {
            userInput.placeholder = 'ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”...';
        } else if (conversationState === 'planning') {
            userInput.placeholder = 'ê³„íšì— ë™ì˜í•˜ì‹œë©´ "ì¢‹ì•„ìš”" ë˜ëŠ” "ë„¤"ë¼ê³  ë‹µí•´ì£¼ì„¸ìš”...';
        } else {
            userInput.placeholder = 'ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜, ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”';
        }
    }

    function resetInput() {
        userInput.value = '';
        fileInput.value = '';
        pastedImageFile = null;
        imagePreview.src = '';
        imagePreview.style.display = 'none';
        fileNameDisplay.textContent = '';
        userInput.placeholder = 'ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜, ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”';
    }

    document.addEventListener('paste', (e) => {
        const items = (e.clipboardData || window.clipboardData).items;
        for (const item of items) {
            if (item.type.indexOf('image') !== -1) {
                pastedImageFile = item.getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(pastedImageFile);
                fileInput.value = '';
                fileNameDisplay.textContent = '';
                userInput.placeholder = 'ì´ë¯¸ì§€ì— ëŒ€í•œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...';
                e.preventDefault();
                return;
            }
        }
    });

    function addFeedbackUI(parentWrapper) {
        if (parentWrapper.querySelector('.feedback-section')) return;
        const feedbackSection = document.createElement('div');
        feedbackSection.className = 'feedback-section';
        feedbackSection.innerHTML = `<button class="feedback-button" onclick="handleFeedback(true, this)">ğŸ‘ í•´ê²°!</button> <button class="feedback-button" onclick="handleFeedback(false, this)">ğŸ‘ ë¬¸ì œìˆìŒ</button>`;
        parentWrapper.appendChild(feedbackSection);
    }

    function handleFeedback(isSolved, buttonElement) {
        const feedbackSection = buttonElement.parentElement;
        if (isSolved) {
            feedbackSection.innerHTML = "ë„ì›€ì´ ë˜ì–´ ë‹¤í–‰ì…ë‹ˆë‹¤! ğŸ˜Š";
            return;
        }
        feedbackSection.innerHTML = '';
        const feedbackForm = document.createElement('form');
        feedbackForm.className = 'input-form';
        feedbackForm.style.padding = '10px 0';
        feedbackForm.innerHTML = `<img id="feedback-image-preview" style="max-width:100px; max-height:40px; margin-right:10px; border-radius:5px; display:none;"><input type="text" placeholder="ë¬¸ì œ ìƒí™©ì„ ì„¤ëª…í•˜ê±°ë‚˜, ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”" style="flex-grow:1; border-radius:20px; padding:10px 18px; border:1px solid #ccc;"><button type="submit" class="submit-button">ğŸš€</button>`;
        feedbackSection.appendChild(feedbackForm);

        let feedbackImageFile = null;
        const feedbackInput = feedbackForm.querySelector('input');
        const feedbackPreview = feedbackForm.querySelector('#feedback-image-preview');

        feedbackForm.addEventListener('paste', (e) => {
             const items = (e.clipboardData || window.clipboardData).items;
             for (const item of items) {
                 if (item.type.indexOf('image') !== -1) {
                     feedbackImageFile = item.getAsFile();
                     const reader = new FileReader();
                     reader.onload = (event) => { feedbackPreview.src = event.target.result; feedbackPreview.style.display = 'block'; };
                     reader.readAsDataURL(feedbackImageFile);
                     e.preventDefault();
                     return;
                 }
             }
        });
        
        feedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isWaitingForResponse) return;
            const feedbackText = feedbackInput.value.trim();
            if (!feedbackText && !feedbackImageFile) return;

            feedbackSection.remove();
            let feedbackUserMessage = `(í”¼ë“œë°±) ${feedbackText}`;
            if (feedbackImageFile) {
                feedbackUserMessage += ' (ì´ë¯¸ì§€ ì²¨ë¶€)';
            }
            addMessage('user', feedbackUserMessage);
            
            const formData = new FormData();
            formData.append('question', feedbackText);
            formData.append('session_id', currentSessionId);
            formData.append('is_feedback', true);
            if (feedbackImageFile) formData.append('image', feedbackImageFile, 'pasted_feedback_image.png');

            sendFormData(formData);
        });
    }
</script>
</body>
</html>